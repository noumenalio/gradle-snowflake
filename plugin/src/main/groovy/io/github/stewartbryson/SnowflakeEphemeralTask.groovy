package io.github.stewartbryson

import groovy.util.logging.Slf4j
import org.gradle.api.tasks.CacheableTask
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.Internal
import org.gradle.api.tasks.Optional
import org.gradle.api.tasks.options.Option

/**
 * A superclass for creating Gradle tasks that use ephemeral Snowflake clones.
 */
@Slf4j
@CacheableTask
abstract class SnowflakeEphemeralTask extends SnowflakeTask {

    /**
     * When enabled, run using an ephemeral Snowflake database cloned from {@link #database}. Useful with CI/CD testing workflows.
     */
    @Optional
    @Input
    @Option(option = "use-ephemeral", description = "When enabled, run using an ephemeral Snowflake database clone.")
    Boolean useEphemeral = extension.useEphemeral

    /**
     * When enabled, don't drop the ephemeral Snowflake database cloned from {@link #database}.
     */
    @Optional
    @Input
    @Option(option = "keep-ephemeral", description = "When enabled, don't drop the ephemeral Snowflake database clone.")
    Boolean keepEphemeral = extension.useEphemeral

    /**
     * Optional: specify the ephemeral database name instead of relying on an autogenerated value. The plugin detects CI/CD environments and uses things like PR numbers, branch names, etc. when available.
     */
    @Optional
    @Input
    @Option(option = "ephemeral-name", description = "Optional: specify the ephemeral database name instead of relying on an autogenerated value.")
    String ephemeralName = extension.ephemeralName

    /**
     * The connection database in case it wasn't in the connection.
     */
    @Internal
    String connectionDatabase

    /**
     * The connection schema in case it wasn't in the connection.
     */
    @Internal
    String connectionSchema

    /**
     * The connection role in case it wasn't in the connection.
     */
    @Internal
    String connectionRole

    /**
     * Create an ephemeral Snowflake clone and return a session to it.
     *
     * @return a session to the ephemeral Snowflake clone.
     */
    def createClone() {
        if (useEphemeral) {
            // record connection attributes
            try {
                connectionDatabase = getSingleValue('SELECT CURRENT_DATABASE()')
                connectionSchema = getSingleValue('SELECT CURRENT_SCHEMA()')
                connectionRole = getSingleValue('SELECT CURRENT_ROLE()')
                log.debug "Connection database, schema, role: $connectionDatabase, $connectionSchema, $connectionRole"
            } catch (Exception e) {
                throw new Exception("Connection context is not available.", e)
            }
            try {
                session.jdbcConnection().createStatement().execute("create database if not exists ${ephemeralName} clone ${connectionDatabase}")
                session.jdbcConnection().createStatement().execute("grant ownership on database ${ephemeralName} to ${connectionRole}")
                session.jdbcConnection().createStatement().execute("use schema ${ephemeralName}.${connectionSchema}")
            } catch (Exception e) {
                throw new Exception("Cloning ephemeral clone failed.", e)
            }
            log.warn "Ephemeral clone $ephemeralName created."
        }
    }

    /**
     * Drop the ephemeral Snowflake clone and return a session to it.
     */
    def dropClone() {
        if (useEphemeral && !keepEphemeral) {
            // drop the ephemeral database
            try {
                session.jdbcConnection().createStatement().execute("drop database if exists ${ephemeralName}")
                session.jdbcConnection().createStatement().execute("use schema ${connectionDatabase}.${connectionSchema}")
            } catch (Exception e) {
                throw new Exception("Dropping ephemeral clone failed.", e)
            }
            log.warn "Ephemeral clone $ephemeralName dropped."
        }
    }
}
