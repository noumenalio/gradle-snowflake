package io.github.stewartbryson

import com.snowflake.snowpark_java.Session
import groovy.util.logging.Slf4j
import org.gradle.api.tasks.CacheableTask
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.Optional
import org.gradle.api.tasks.options.Option

/**
 * A Cacheable Gradle task for publishing Java-based applications as UDFs to Snowflake.
 */
@Slf4j
@CacheableTask
abstract class SnowflakeEphemeralTask extends SnowflakeTask {

    /**
     * When enabled, run using an ephemeral Snowflake database cloned from {@link #database}. Useful with CI/CD testing workflows.
     */
    @Optional
    @Input
    @Option(option = "use-ephemeral", description = "When enabled, run using an ephemeral Snowflake database clone.")
    Boolean useEphemeral = extension.useEphemeral

    /**
     * When enabled, don't drop the ephemeral Snowflake database cloned from {@link #database}.
     */
    @Optional
    @Input
    @Option(option = "keep-ephemeral", description = "When enabled, don't drop the ephemeral Snowflake database clone.")
    Boolean keepEphemeral = extension.useEphemeral

    /**
     * Optional: specify the ephemeral database name instead of relying on an autogenerated value. The plugin detects CI/CD environments and uses things like PR numbers, branch names, etc. when available.
     */
    @Optional
    @Input
    @Option(option = "ephemeral-name", description = "Optional: specify the ephemeral database name instead of relying on an autogenerated value.")
    String ephemeralName = extension.ephemeralName

    /**
     * Create an ephemeral Snowflake clone and return a session to it.
     *
     * @return a session to the ephemeral Snowflake clone.
     */
    def createClone() {
        if (useEphemeral) {
            session.jdbcConnection().createStatement().execute("create or replace database ${ephemeralName} clone $database")
            session.jdbcConnection().createStatement().execute("grant ownership on database ${ephemeralName} to $role")
            session.jdbcConnection().createStatement().execute("use schema ${ephemeralName}.${schema}")
            log.warn "Ephemeral clone $ephemeralName created."
        }
    }

    /**
     * Drop the ephemeral Snowflake clone and return a session to it.
     */
    def dropClone() {
        if (useEphemeral && !keepEphemeral) {
            // drop the ephemeral database
            session.jdbcConnection().createStatement().execute("drop database if exists ${extension.ephemeralName}")
            session.jdbcConnection().createStatement().execute("use schema ${database}.${schema}")
            log.warn "Ephemeral clone $ephemeralName dropped."
        }
    }
}
